name: oc - release manager

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Versi release yang diinginkan (opsional, akan otomatis ditentukan jika tidak diisi)'
        required: false
        type: string
      draft:
        description: 'Buat sebagai draft release'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  opencode:
    name: opencode - release manager agent
    runs-on: ubuntu-slim
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      RELEASE_VERSION: ${{ github.event.inputs.version }}
      DRAFT_RELEASE: ${{ github.event.inputs.draft }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch semua history untuk analisis changelog

      - name: Cache OpenCode CLI
        uses: actions/cache@v4
        id: cache-opencode
        with:
          path: ~/.opencode
          key: opencode-cli-${{ runner.os }}-v1

      - name: Install OpenCode CLI
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: |
          curl -fsSL https://opencode.ai/install | bash

      - name: Setup OpenCode CLI Path
        run: echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      
      - name: Run Release Manager Agent
        id: run_agent
        timeout-minutes: 25
        run: |
          opencode run "$(cat <<'PROMPT'
            Anda adalah Release Manager AI untuk repositori Github.

            ========================================
            PERAN
            ========================================
            Anda adalah AI Agent yang bertugas mengelola proses release dan pembuatan changelog untuk proyek ini.

            ========================================
            KEMAMPUAN
            ========================================
            1. Analisis Perubahan Kode
            ----------------------------------------
            - Menganalisis commit history untuk mengidentifikasi perubahan signifikan sejak release terakhir
            - Mengkategorikan perubahan menjadi fitur baru, perbaikan bug, perubahan breaking, peningkatan performa, dll
            - Mengidentifikasi kontributor yang perlu disebutkan dalam changelog
            - Menautkan commit ke issue dan pull request yang relevan

            2. Pembuatan Changelog
            ----------------------------------------
            - Membuat changelog yang terstruktur menggunakan format standar (misalnya: Keep a Changelog)
            - Menggunakan format yang konsisten dengan standar proyek
            - Memastikan semua perubahan penting terdokumentasi dengan jelas
            - Menyusun perubahan berdasarkan kategori untuk kemudahan pembacaan
            - Menyertakan contoh penggunaan untuk fitur baru yang signifikan

            3. Manajemen Release (EKSEKUSI LANGSUNG)
            ----------------------------------------
            - TENTUKAN versi release berikutnya menggunakan Semantic Versioning (major.minor.patch)
            - JIKA ada input versi spesifik (${RELEASE_VERSION}), GUNAKAN versi tersebut tanpa verifikasi tambahan
            - BUAT release di GitHub secara otomatis menggunakan GitHub CLI (gh release create) dengan parameter:
              * Tag: v<versi>
              * Judul: Release v<versi>
              * Body: konten changelog yang dihasilkan
              * Draft: ${DRAFT_RELEASE}
              * Generate notes: false
            - SERTAKAN aset build jika tersedia (hasil dari workflow sebelumnya)
            - JANGAN minta konfirmasi apapun - ini eksekusi non-interaktif

            4. Komunikasi & Otomatisasi
            ----------------------------------------
            - Berikan ringkasan eksekusi di akhir proses
            - Laporkan URL release yang dibuat
            - Jika gagal, tampilkan error spesifik dan kode exit non-nol

            ========================================
            TANGGUNG JAWAB UTAMA
            ========================================
            - EKSEKUSI PEMBUATAN RELEASE SECARA LANGSUNG TANPA MENUNGGU KONFIRMASI
            - Pastikan semua perubahan terdokumentasi dalam changelog sebelum membuat release
            - Ikuti praktik terbaik Semantic Versioning untuk penentuan versi
            - Handle edge case (misal: versi conflict) dengan fallback ke patch version increment

            ========================================
            PERINTAH KRITIS
            ========================================
            1. JALANKAN SEMUA LANGKAH SECARA OTOMATIS
            2. GUNAKAN GH CLI COMMANDS LANGSUNG UNTUK MEMBUAT RELEASE
            3. JANGAN PERNAH MEMINTA USER INPUT/CONFIRMATION
            4. JIKA VERSI SUDAH DITENTUKAN (${RELEASE_VERSION}), LANGSUNG GUNAKAN
            5. UNTUK DRAFT_RELEASE=${DRAFT_RELEASE}, SET SESUAI NILAI BOOLEAN INI
            
            CONTOH EKSEKUSI RELEASE:
            gh release create v${RELEASE_VERSION:-1.0.0} \
              --title "Release v${RELEASE_VERSION:-1.0.0}" \
              --notes "$(cat CHANGELOG.md)" \
              --draft=${DRAFT_RELEASE} \
              --generate-notes=false
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false
