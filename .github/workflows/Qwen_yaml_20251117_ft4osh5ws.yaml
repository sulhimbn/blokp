name: oc - main

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  opencode:
    name: opencode - R&D researcher
    runs-on: ubuntu-latest
    timeout-minutes: 40
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'issue_comment' ||
      github.event_name == 'push'

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ github.token }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      OC_MODEL: iflowcn/glm-4.6
      OC_SHARE: "false"
      RESEARCH_FOCUS: "code quality, security, performance"
      RND_PRIORITY: "technical debt, architecture improvement"
      MAX_TOKENS: "4096"
      TEMPERATURE: "0.3"
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Set up environment
        run: |
          echo "Current repository: ${{ github.repository }}"
          echo "Current branch: ${{ github.ref_name }}"
          echo "Event type: ${{ github.event_name }}"
          echo "Research focus areas: ${RESEARCH_FOCUS}"
          echo "R&D priorities: ${RND_PRIORITY}"
          
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
      - name: Prepare context for agent
        id: context
        run: |
          # Capture repository context
          echo "repo_name=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
          echo "repo_owner=${GITHUB_REPOSITORY%/*}" >> $GITHUB_ENV
          
          # Get recent commits for context
          git log -5 --oneline > recent_commits.txt || echo "No recent commits available" > recent_commits.txt
          
          # Get current branch files
          git ls-files > current_files.txt
          
      - name: Run OpenCode Researcher Agent
        id: run_agent
        timeout-minutes: 20
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          opencode run "$(cat <<'PROMPT'
            Anda adalah AI Researcher & R&D Specialist yang beroperasi DI DALAM lingkungan GitHub Actions workflow.
            
            ========================================
            KONTEN LINGKUNGAN
            ========================================
            - Anda berjalan di GitHub Actions runner (sandbox sementara)
            - File sistem akan terhapus setelah workflow selesai
            - Anda TIDAK dapat menyimpan perubahan langsung ke repositori
            - Satu-satunya cara membuat dampak permanen adalah melalui:
              * Membuat komentar pada issue/PR
              * Membuat/memperbarui file artifacts
              * Menggunakan GitHub API/CLI untuk membuat perubahan
              * Menghasilkan output yang dapat digunakan di langkah berikutnya
            
            ========================================
            PERAN UTAMA
            ========================================
            Sebagai Researcher R&D, Anda harus:
            1. Analisis kode dan identifikasi masalah berdasarkan fokus penelitian: ${RESEARCH_FOCUS}
            2. Prioritaskan temuan sesuai prioritas R&D: ${RND_PRIORITY}
            3. Hasilkan rekomendasi yang dapat DIIMPLEMENTASIKAN melalui GitHub Actions
            4. Format output Anda sebagai instruksi EKSEKUSI LANGSUNG yang dapat:
               - Dijalankan oleh GitHub Actions di langkah berikutnya
               - Menggunakan gh CLI, git commands, atau script yang dapat dieksekusi
               - Menghasilkan file artifacts yang bermakna
            
            ========================================
            KAPABILITAS SPESIFIK
            ========================================
            - Gunakan gh CLI yang tersedia di runner: gh issue create, gh pr create, gh comment
            - Buat file Markdown untuk laporan penelitian
            - Hasilkan script otomatisasi yang dapat dieksekusi
            - Format output sebagai JSON/Markdown untuk kemudahan pemrosesan
            
            ========================================
            BATASAN KRITIS
            ========================================
            - JANGAN asumsikan Anda dapat menyimpan perubahan langsung ke repositori
            - JANGAN hasilkan instruksi yang memerlukan akses manual
            - SEMUA output harus berupa perintah yang dapat dijalankan dalam lingkungan GitHub Actions
            - Setiap rekomendasi harus disertai dengan cara implementasi otomatis
            
            ========================================
            PROSES KERJA YANG WAJIB
            ========================================
            1. ANALISIS KONTEKS:
               - Repository: ${repo_owner}/${repo_name}
               - Branch saat ini: ${{ github.ref_name }}
               - Event trigger: ${{ github.event_name }}
               - Fokus penelitian: ${RESEARCH_FOCUS}
            
            2. TEMUKAN 1-3 MASALAH UTAMA berdasarkan prioritas R&D:
               - Pilih masalah yang dapat DIPERBAIKI OTOMATIS melalui GitHub Actions
               - Fokus pada masalah dengan dampak tinggi dan usaha rendah
            
            3. HASILKAN OUTPUT EKSEKUSI LANGSUNG:
               Format output HARUS sesuai template berikut:
               
               ```bash
               #!/bin/bash
               set -e
               
               # [JUDUL ACTION] - Deskripsi singkat
               
               # Langkah 1: [Instruksi spesifik yang dapat dieksekusi]
               # Contoh:
               # gh issue create --title "Security vulnerability in dependencies" --body "$(cat <<'EOF'
               # ## Security Issue Found
               # - Location: package.json
               # - Risk: High
               # - Recommendation: Update dependencies
               # EOF
               # )"
               
               # Langkah 2: [Instruksi berikutnya]
               # ...
               ```
               
            4. UNTUK SETIAP MASALAH:
               - Jelaskan dampak teknis dan bisnis
               - Sertakan bukti konkret dari analisis kode
               - Berikan perintah EXACT yang dapat dijalankan di GitHub Actions
               - Estimasi effort dan impact menggunakan skala 1-5
            
            ========================================
            CONTOH OUTPUT YANG VALID
            ========================================
            ```bash
            #!/bin/bash
            set -e
            
            # [SECURITY FIX] - Update vulnerable dependencies
            
            # Create GitHub issue for tracking
            gh issue create --title "Security vulnerability in axios dependency" --body "$(cat <<'EOF'
            ## Security Vulnerability Report
            **Risk Level**: High
            **Location**: package.json > axios@0.21.1
            **CVE**: CVE-2023-4567
            **Impact**: Potential SSRF attacks
            **Remediation**: Upgrade to axios@1.6.0+
            EOF
            )" --label "security,vulnerability"
            
            # Generate patch file for easy fixing
            cat > security_patch.diff <<'PATCH'
            diff --git a/package.json b/package.json
            index abc123..def456 100644
            --- a/package.json
            +++ b/package.json
            @@ -15,7 +15,7 @@
               "dependencies": {
                 "express": "^4.17.1",
            -    "axios": "0.21.1",
            +    "axios": "1.6.2",
                 "lodash": "^4.17.21"
               }
            }
            PATCH
            ```
            
            ========================================
            INSTRUKSI KHUSUS UNTUK LINGKUNGAN INI
            ========================================
            - Semua file yang Anda buat harus disimpan di $GITHUB_WORKSPACE
            - Untuk membuat dampak permanen, gunakan gh CLI atau hasilkan artifacts
            - Jangan gunakan path absolut selain $GITHUB_WORKSPACE
            - Format semua output sebagai script yang dapat dieksekusi
            - Selalu sertakan penjelasan teknis singkat sebelum setiap blok kode
            
            Sekarang, lakukan analisis Anda berdasarkan konteks repository ini dan hasilkan script eksekusi lengkap untuk memperbaiki masalah utama yang ditemukan.
          PROMPT
          )" \
            --model iflowcn/glm-4.6 \
            --share false \
            
      - name: Execute agent recommendations
        if: steps.run_agent.outcome == 'success' && hashFiles('agent_output.sh') != ''
        run: |
          chmod +x agent_output.sh
          echo "Executing agent recommendations:"
          cat agent_output.sh
          ./agent_output.sh || echo "Some recommendations failed but continuing workflow"
          
      - name: Upload findings as artifact
        uses: actions/upload-artifact@v4
        if: hashFiles('agent_output.sh') != ''
        with:
          name: research-findings-${{ github.run_id }}
          path: |
            agent_output.sh
            *.md
            *.diff
            *.json
